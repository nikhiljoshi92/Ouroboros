digraph Coordinator_sm {

    node
        [shape=Mrecord width=1.5];

    subgraph cluster_CoordinatorFSM {

        label="CoordinatorFSM";

        //
        // States (Nodes)
        //

        "CoordinatorFSM::Unstable"
            [label="{Unstable}"];

        "CoordinatorFSM::Stable"
            [label="{Stable}"];

        "CoordinatorFSM::EstablishReplicators"
            [label="{EstablishReplicators}"];

        "CoordinatorFSM::ReplicatorsEstablished"
            [label="{ReplicatorsEstablished}"];

        "CoordinatorFSM::Rebalance"
            [label="{Rebalance}"];

        "CoordinatorFSM::AwaitingTakeover"
            [label="{AwaitingTakeover}"];

        "CoordinatorFSM::Shutdown"
            [label="{Shutdown}"];

        "CoordinatorFSM::DefaultState"
            [label="{&laquo; Default &raquo;}"];

        "CoordinatorFSM::AwaitingTakeover::ControllerFSM"
            [label="{ControllerFSM|O-O\r}"]

        "CoordinatorFSM::EstablishReplicators::ControllerFSM"
            [label="{ControllerFSM|O-O\r}"]

        "%start"
            [label="" shape=circle style=filled fillcolor=black width=0.25];

        //
        // Transitions (Edges)
        //

        "CoordinatorFSM::Unstable" -> "CoordinatorFSM::EstablishReplicators"
            [label="stabilize/\l"];

        "CoordinatorFSM::Stable" -> "CoordinatorFSM::EstablishReplicators"
            [label="establishReplicators/\l"];

        "CoordinatorFSM::EstablishReplicators" -> "CoordinatorFSM::EstablishReplicators::ControllerFSM"
            [label="coordinateReplicators/\lpush(ControllerFSM::CoordinateReplicators)\l"];

        "CoordinatorFSM::EstablishReplicators" -> "CoordinatorFSM::ReplicatorsEstablished"
            [label="replicatorsEstablished/\l"];

        "CoordinatorFSM::ReplicatorsEstablished" -> "CoordinatorFSM::AwaitingTakeover::ControllerFSM"
            [label="rebalance/\lpush(ControllerFSM::CoordinateRebalance)\l"];

        "CoordinatorFSM::ReplicatorsEstablished" -> "CoordinatorFSM::Rebalance"
            [label="rebalance/\l"];

        "CoordinatorFSM::Rebalance" -> "CoordinatorFSM::AwaitingTakeover"
            [label="rebalanced/\l"];

        "CoordinatorFSM::AwaitingTakeover" -> "CoordinatorFSM::Stable"
            [label="commitTakeover/\l"];

        "CoordinatorFSM::AwaitingTakeover" -> "CoordinatorFSM::Stable"
            [label="takeoverComplete/\l"];

        "CoordinatorFSM::DefaultState" -> "CoordinatorFSM::Unstable"
            [label="destabilize/\l"];

        "CoordinatorFSM::AwaitingTakeover::ControllerFSM" -> "CoordinatorFSM::AwaitingTakeover"
            [label="pop/"]

        "CoordinatorFSM::EstablishReplicators::ControllerFSM" -> "CoordinatorFSM::EstablishReplicators"
            [label="pop/"]

        "%start" -> "CoordinatorFSM::Unstable"
    }

    subgraph cluster_ControllerFSM {

        label="ControllerFSM";

        //
        // States (Nodes)
        //

        "ControllerFSM::CoordinateReplicators"
            [label="{CoordinateReplicators}"];

        "ControllerFSM::CoordinateRebalance"
            [label="{CoordinateRebalance}"];

        "ControllerFSM::Rebalance"
            [label="{Rebalance}"];

        "ControllerFSM::CoordinateTakeover"
            [label="{CoordinateTakeover}"];

        "ControllerFSM::pop(destabilize)"
            [label="" width=1]

        "ControllerFSM::pop(takeoverComplete)"
            [label="" width=1]

        "ControllerFSM::pop(replicatorsEstablished)"
            [label="" width=1]

        "ControllerFSM::%end"
            [label="" shape=doublecircle style=filled fillcolor=black width=0.15];

        "push(ControllerFSM::CoordinateRebalance)"
            [label="" shape=plaintext];

        "push(ControllerFSM::CoordinateReplicators)"
            [label="" shape=plaintext];

        //
        // Transitions (Edges)
        //

        "ControllerFSM::CoordinateReplicators" -> "ControllerFSM::pop(replicatorsEstablished)"
            [label="replicatorsEstablished/\l"];

        "ControllerFSM::CoordinateReplicators" -> "ControllerFSM::pop(destabilize)"
            [label="destabilize/\l"];

        "ControllerFSM::CoordinateRebalance" -> "ControllerFSM::Rebalance"
            [label="rebalance/\l"];

        "ControllerFSM::Rebalance" -> "ControllerFSM::CoordinateTakeover"
            [label="memberRebalanced/\l"];

        "ControllerFSM::Rebalance" -> "ControllerFSM::pop(destabilize)"
            [label="destabilize/\l"];

        "ControllerFSM::CoordinateTakeover" -> "ControllerFSM::pop(takeoverComplete)"
            [label="memberTakeoverComplete/\l"];

        "ControllerFSM::CoordinateTakeover" -> "ControllerFSM::pop(destabilize)"
            [label="destabilize/\l"];

        "ControllerFSM::pop(destabilize)" -> "ControllerFSM::%end"
            [label="pop(destabilize);\l"];

        "ControllerFSM::pop(takeoverComplete)" -> "ControllerFSM::%end"
            [label="pop(takeoverComplete);\l"];

        "ControllerFSM::pop(replicatorsEstablished)" -> "ControllerFSM::%end"
            [label="pop(replicatorsEstablished);\l"];

        "push(ControllerFSM::CoordinateRebalance)" -> "ControllerFSM::CoordinateRebalance"
            [arrowtail=odot];

        "push(ControllerFSM::CoordinateReplicators)" -> "ControllerFSM::CoordinateReplicators"
            [arrowtail=odot];
    }

}
